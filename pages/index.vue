<template>
  <!-- class="section" -->
  <section>
    <!-- {{ data }} -->
    <b-field>
      <b-input placeholder="Название" v-model="filterByName"></b-input>
    </b-field>
    <b-field>
      <b-checkbox v-model="filterByWeather">
        Включать только районы где сейчас ясно
      </b-checkbox>
    </b-field>
    <b-field>
      <b-radio-button
        v-model="sortParam"
        native-value="name"
        type="is-primary is-light is-outlined"
      >
        <span>Название</span>
      </b-radio-button>

      <b-radio-button
        v-model="sortParam"
        native-value="temp"
        type="is-primary is-light is-outlined"
      >
        <span>Температура</span>
      </b-radio-button>
    </b-field>

    <div v-if="this.data != 0">
      <ul class="weather-info">
        <li v-for="item in orderedItems" :key="item.name">
          <!-- {{ item.id }} -->
          <NuxtLink
            :to="{ name: 'posts-id', params: { id: item.id, name: item.name } }"
          >
            <div class="wrapper">
              <img
                :src="
                  `https://openweathermap.org/img/wn/${item.weather[0]['icon']}.png`
                "
              />
            </div>
            <span>
              {{ item.name }} - {{ item.weather[0].description }} -
              {{ getCelseTemp(item.main.temp) }}&deg;
            </span>
          </NuxtLink>
          <img
            class="del"
            src="@/assets/img/close.svg"
            @click="removeCity(item)"
            alt=""
          />
        </li>
      </ul>
    </div>
    <div class="" v-else-if="this.errorPull != ''">
      Произошла критическая ошибка!<br />
      {{ errorPull }}
    </div>
    <div class="" v-else>
      <span>Выгружаем данные по городам...</span>

      <b-progress type="is-primary mt"></b-progress>
    </div>
    <div class="flex">
      <b-field :type="input_type" label="Название города (eng)">
        <b-input v-model="inputValueOfCity"></b-input>
      </b-field>
      <b-button type="is-primary" @click="addNewCity">Добавить</b-button>
    </div>
  </section>
</template>

<script>
export default {
  name: "HomePage",

  components: {
    // Card
  },

  data() {
    return {
      filterByName: "",
      filterByWeather: false,

      sortParam: "name",
      data: [],

      input_type: "",

      inputValueOfCity: "",
      radioButton: "",
      errorPull: "",

      city: [524925, 525184, 524901, 536203, 1486209, 1489425, 1489474, 554234]
      // Все города, для тестов.
      // city:[452063,452949,452960,453080,461699,461704,461705,461715,461720,461742,461756,461779,461781,461794,461835,461862,461867,461873,461910,461916,461920,461964,462007,462008,462022,462035,462050,462052,462095,462134,462169,462192,462197,462203,462208,462240,462256,462305,462313,462320,462322,462323,462330,462352,462357,462377,462383,462413,462444,462467,462522,462528,462626,462642,462668,462755,462790,462792,462814,462815,462822,462864,462870,462878,462914,462942,462964,462970,462976,462983,462984,462988,463001,463035,463037,463038,463043,463050,463051,463053,463082,463134,463144,463145,463217,463229,463252,463254,463340,463343,463355,463356,463370,463446,463465,463516,463533,463544,463560,463568,463575,463597,463622,463637,463655,463666,463685,463690,463702,463710,463726,463739,463782,463790,463801,463824,463826,463828,463829,463830,463834,463835,463838,463854,463880,463885,463889,463912,463913,463951,463966,464018,464090,464094,464101,464109,464110,464112,464130,464159,464176,464179,464180,464192,464217,464219,464260,464290,464343,464468,464473,464503,464506,464527,464557,464616,464621,464625,464676,464687,464700,464708,464717,464730,464737,464790,464806,464829,464891,464943,464946,464958,464993,465011,465014,465019,465027,465051,465057,465174,465261,465273,465274,465279,465286,465291,465337,465355,465433,465436,465437,465446,465463,465476,465477,465490,465501,465532,465543,465572,465622,465625,465632,465646,465720,465725,465726,465754,465783,465795,465824,465825,465831,465923,465934,465984,466013,466060,466084,466099,466106,466135,466200,466215,466230,466232,466258,466272,466285,466301,466303,466314,466341,466349,466423,466448,466470,466538,466637,466658,466674,466699,466710,466724,466740,466748,466798,466806,466885,466989,466990,467023,467029,467030,467037,467084,467103,467104,467120,467134,467155,467175,467218,467235,467238,467246,467252,467260,467315,467323,467330,467375,467376,467380,467406,467464,467479,467525,467527,467539,467542,467565,467629,467711,467716,467727,467749,467753,467787,467819,467850,467854,467856,467896,467934,467951,467978,468011,468030,468042,468044,468063,468082,468091,468102,468116,468119,468127,468180,468197,468250,468307,468345,468364,468390,468397,468401,468418,468424,468454,468479,468483,468486,468560,468587,468632,468657,468671,468682,468691,468747,468776,468782,468799,468859,468866,468867,468898,468899,468902,468927,468983,468991,469005,469017,469049,469050,469081,469083,469087,469151,469178,469181,469186,469252,469274,469275,469341,469372,469396,469460,469473,469512,469533,469542,469544,469550,469577,469602,469633,469635,469646,469655,469671,469678,469753,469809,469844,469856,469864,469900,469933,469960,469991,469995,470012,470042,470083,470118,470128,470135,470142,470144,470148,470151,470212,470218,470252,470268,470274,470299,470304,470338,470346,470368,470390,470400,470437,470444,470451,470473,470494,470499,470530,470546,470549,470566,470653,470666,470676,470734,470743,470762,470782,470783,470817,470819,470820,470845,470905,471101,471141,471153,471160,471172,471188,471189,471245,471271,471291,471308,471312,471323,471329,471418,471430,471457,471461,471499,471501,471512,471573,471607,471616,471617,471620,471633,471639,471656,471659,471667,471748,471760,471786,471799,471812,471820,471855,471877,471880,471887,471889,471909,471911,471938,471939,471971,471980,472026,472039,472041,472045,472046,472061,472079,472088,472113,472152,472200,472210,472214,472229,472231,472234,472271,472278,472306,472308,472328,472357,472363,472387,472391,472425,472428,472430,472431,472433,472452,472454,472459,472464,472471,472490,472494,472556,472625,472650,472663,472684,472714,472722,472732,472743,472750,472751,472755,472757,472761,472777,472794,472795,472863,472871,472878,472880,472887,472900,472942,472961,472976,472982,473020,473021,473022,473051,473083,473085,473087,473119,473142,473157,473166,473223,473236,473247,473249,473263,473265,473295,473325,473349,473353,473378,473382,473387,473442,473522,473535,473537,473546,473562,473563,473611,473627,473661,473712,473749,473762,473778,473788,473856,473903,473904,473910,473936,473943,473972,473994,473998,474004,474013,474054,474056,474059,474144,474163,474203,474207,474209,474244,474290,474292,474321,474324,474346,474354,474370,474462,474468,474470,474473,474603,474643,474663,474669,474743,474751,474795,474821,474897,474902,474916,474926,474931,474940,475003,475023,475030,475041,475060,475092,475100,475131,475157,475196,475206,475218,475242,475255,475259,475272,475279,475281,475349,475369,475405,475424,475438,475455,475463,475469,475508,475519,475599,475614,475617,475619,475642,475653,475654,475689,475699,475700,475701,475777,475778,475779,475782,475819,475837,475840,475845,475868,475881,475921,475923,475927,475936,475938,475941,475955,475965,476020,476028,476046,476055,476062,476077,476106,476141,476173,476207,476228,476231,476252,476257,476297,476343,476344,476350,476359,476368,476372,476417,476428,476538,476540,476548,476567,476595,476612,476630,476732,476798,476958,476982,477004,477012,477034,477039,477047,477109,477134,477162,477192,477218,477260,477267,477279,477280,477283,477301,477337,477340,477418,477424,477440,477450,477466,477473,477494,477530,477541,477566,477571,477579,477622,477626,477629,477649,477656,477680,477682,477744,477762,477774,477789,477795,477825,477846,477874,477940,477958,477969,478001,478036,478044,478050,478064,478071,478079,478080,478093,478096,478130,478132,478197,478203,478213,478269,478271,478297,478317,478323,478344,478349,478367,478379,478435,478479,478485,478505,478532,478538,478544,478557,478563,478565,478581,478601,478620,478631,478640,478689,478699,478704,478711,478724,478757,478769,478781,478782,478836,478849,478920,478948,478963,478996,479021,479028,479055,479071,479119,479123,479140,479179,479183,479184,479198,479201,479241,479242,479258,479338,479343,479411,479426,479442,479471,479472,479474,479487,479512,479523,479532,479535,479537,479539,479553,479561,479596,479613,479619,479622,479640,479685,479687,479704,479716,479724,479751,479762,479844,479850,479871,479933,479985,479999,480004,480041,480043,480060,480085,480089,480107,480122,480145,480209,480212,480267,480301,480346,480376,480378,480410,480420,480453,480461,480484,480508,480562,480608,480620,480637,480644,480654,480665,480685,480704,480716,480798,480804,480851,480876,480884,480907,480985,480994,481007,481018,481036,481037,481097,481117,481121,481152,481162,481181,481244,481275,481282,481313,481323,481350,481418,481439,481467,481470,481491,481492,481498,481499,481501,481542,481543,481548,481580,481603,481604,481605,481608,481618,481648,481725,481818,481839,481865,481896,481900,481938,481941,481955,481960,481964,481985,482042,482096,482104,482123,482167,482170,482203,482219,482230,482260,482275,482283,482303,482309,482322,482329,482364,482372,482390,482401,482432,482443,482577,482582,482589,482654,482655,482680,482702,482714,482742,482761,482810,482864,482879,482886,482890,482893,482919,482960,482965,482986,482992,483001,483019,483020,483029,483039,483044,483059,483137,483142,483150,483184,483200,483230,483232,483240,483269,483281,483326,483341,483379,483386,483439,483465,483469,483495,483541,483551,483575,483613,483642,483645,483650,483652,483654,483657,483661,483684,483689,483691,483692,483696,483699,483710,483775,483828,483873,483883,483898,483901,483904,484017,484034,484048,484122,484127,484138,484146,484162,484180,484192,484232,484251,484277,484285,484287,484290,484294,484296,484314,484334,484335,484340,484346,484367,484373,484396,484405,484448,484449,484522,484638,484644,484646,484670,484674,484720,484725,484747,484769,484770,484771,484826,484849,484856,484907,484910,484912,484972,485064,485119,485140,485153,485162,485173,485203,485206,485215,485217,485230,485239,485273,485275,485279,485280,485304,485313,485342,485351,485413,485432,485449,485496,485516,485576,485609,485630,485639,485642,485643,485660,485698,485699,485700,485731,485747,485763,485769,485785,485799,485817,485820,485824,485871,485878,485888,485906,485919,485952,485964,486011,486015,486034,486043,486048,486064,486071,486073,486085,486095,486110,486137,486148,486163,486176,486178,486186,486190,486203,486211,486236,486260,486272,486282,486365,486398,486413,486444,486456,486556,486584,486626,486629,486645,486665,486697,486725,486778,486816,486834,486840,486845,486848,486874,486894,486914,486923,486968,486983,487006,487042,487095,487110,487131,487138,487147,487150,487159,487198,487227,487237,487246,487255,487266,487272,487275,487305,487318,487321,487372,487441,487444,487446,487464,487495,487498,487505,487543,487574,487611,487628,487629,487631,487635,487677,487679,487687,487727,487740,487743,487776,487837,487839,487846,487871,487928,487940,487962,487988,488128,488141,488142,488206,488207,488214,488252,488275,488284,488291,488324,488352,488360,488408,488466,488488,488500,488523,488557,488587,488593,488606,488608,488618,488635,488703,488706,488713,488721,488730,488742,488758,488777,488785,488802,488808,488831,488839,488847,488852,488859,488864,488881,488914,488926,488927,488946,488957,488973,488996,489011,489021,489043,489057,489059,489062,489063,489069,489087,489088,489102,489119,489135,489158,489162,489164,489192,489226,489248,489264,489271,489278,489281,489287,489288,489290,489393,489410,489446,489495,489601,489648,489652,489655,489671,489686,489693,489701,489741,489743,489768,489770,489778,489798,489862,489863,489868,489871,489910,489952,489990,489994,489997,489998,489999,490039,490040,490064,490065,490066,490067,490068,490069,490094,490100,490108,490135,490171,490172,490177,490186,490211,490213,490217,490276,490277,490297,490300,490323,490377,490391,490425,490437,490466,490510,490554,490637,490645,490683,490724,490726,490737,490743,490747,490750,490846,490851,490914,490918,490936,490976,490981,490983,490993,490996,490997,491003,491019,491023,491025,491029,491053,491075,491079,491085,491135,491144,491145,491155,491158,491171,491172,491196,491198,491220,491222,491231,491250,491251,491280,491281,491299,491351,491352,491380,491384,491422,491480,491493,491538,491566,491576,491591,491620,491660,491669,491670,491684,491685,491687,491777,491882,491951,491952,491954,491966,492012,492015,492042,492094,492112,492157,492162,492218,492234,492250,492254,492271,492330,492333,492337,492339,492351,492358,492376,492397,492404,492414,492448,492579,492592,492596,492633,492657,492685,492708,492712,492723,492747,492756,492777,492795,492821,492828,492835,492853,492860,492894,492920,492944,492964,492970,493040,493089,493128,493132,493160,493163,493184,493201,493228,493231,493279,493316,493328,493344,493394,493405,493422,493452,493463,493472,493481,493526,493566,493584,493600,493630,493634,493702,493721,493795,493805,493839,493842,493866,493926,493930,493931,493939,493970,493997,494020,494087,494105,494116,494124,494157,494199,494202,494249,494251,494275,494304,494315,494317,494320,494322,494366,494378,494427,494430,494481,494505,494514,494519,494531,494750,494751,494806,494846,494877,494884,494900,494901,494920,494925,494946,494967,494970,494985,495000,495005,495030,495062,495063,495065,495080,495102,495112,495115,495137,495187,495190,495206,495222,495230,495260,495327,495344,495388,495391,495392,495394,495397,495412,495442,495470,495472,495508,495515,495518,495532,495536,495562,495575,495619,495670,495688,495742,495744,495746,495752,495756,495767,495770,495822,495835,495891,495893,495904,495915,495918,495922,495925,495940,495957,495969,495971,495983,496012,496015,496023,496035,496097,496158,496159,496162,496171,496204,496211,496246,496262,496267,496269,496275,496278,496285,496290,496307,496346,496358,496361,496381,496385,496422,496456,496461,496474,496478,496493,496503,496505,496517,496519,496527,496561,496564,496568,496582,496584,496610,496638,496721,496735,496795,496802,496854,496859,496869,496879,496906,496934,496935,496951,496954,496957,497019,497024,497094,497097,497162,497165,497171,497199,497204,497206,497210,497211,497218,497242,497243,497255,497260,497271,497273,497286,497303,497342,497377,497382,497411,497450,497470,497512,497534,497546,497547,497592,497610,497616,497626,497631,497661,497672,497691,497698,497699,497705,497764,497774,497791,497826,497834,497872,497927,497928,497971,497984,497988,497990,497995,498001,498035,498039,498064,498093,498114,498147,498179,498264,498295,498337,498349,498356,498366,498390,498394,498411,498418,498420,498421,498430,498437,498462,498501,498525,498537,498538,498603,498605,498655,498666,498671,498672,498677,498687,498696,498698,498703,498708,498711,498729,498760,498781,498783,498785,498817,498833,498834,498856,498859,498866,498867,498877,498888,498889,498899,498904,498952,498956,498974,499002,499017,499025,499037,499040,499051,499055,499068,499099,499133,499135,499161,499228,499254,499292,499298,499319,499342,499363,499404,499421,499438,499439,499447,499452,499453,499456,499493,499528,499535,499539,499540,499622,499624,499626,499629,499649,499684,499709,499717,499727,499728,499748,499773,499778,499782,499811,499874,499906,499938,499950,499975,499987,500004,500023,500024,500034,500047,500054,500059,500060,500065,500095,500096,500149,500184,500228,500240,500299,500303,500316,500350,500354,500400,500413,500423,500479,500502,500525,500545,500566,500588,500589,500664,500667,500678,500695,500701,500709,500721,500756,500776,500818,500843,500886,500917,500933,500957,500982,500996,501006,501012,501027,501035,501043,501091,501165,501166,501175,501177,501183,501187,501215,501231,501265,501283,501287,501296,501315,501320,501349,501361,501405,501408,501422,501425,501440,501468,501492,501566,501579,501616,501625,501670,501716,501730,501732,501774,501775,501782,501783,501787,501788,501847,501928,501938,501977,501978,502010,502011,502016,502018,502036,502049,502069,502078,502103,502124,502131,502137,502145,502147,502157,502182,502185,502191,502265,502267,502270,502276,502285,502306,502339,502345,502389,502400,502408,502423,502426,502445,502447,502540,502542,502622,502623,502666,502681,502721,502724,502734,502738]
    };
  },
  created() {
    this.$nuxt.$on("changedItem", obj => {
      this.$set(
        this.data,
        this.data.map(o => {
          if (o.id == obj.id) {
            o.name = obj.message;
            console.log(o.id + " - " + obj.id + " - " + o.name);
          }
        })
      );

      this.data.push(
        (this.data.filter(function(item) {
          return item.id == obj.id;
        })[0].name = obj.message)
      );

      // this.data.splice(this.data.lenght);
      console.log(this.data);
    });
  },
  computed: {
    filteredItems: function() {
      var name = this.filterByName;
      var weather = this.filterByWeather;

      return this.data.filter(function(elem) {
        if (!weather) {
          if (name === "") return true;
          else return elem.name.toLowerCase().indexOf(name.toLowerCase()) > -1;
        } else {
          if (name === "") return true && elem.weather[0].description == "ясно";
          else
            return (
              elem.name.toLowerCase().indexOf(name.toLowerCase()) > -1 &&
              elem.weather[0].description == "ясно"
            );
        }
      });
    },
    orderedItems() {
      switch (this.sortParam) {
        case "name":
          return this.filteredItems.sort(orderByName);
        case "temp":
          return this.filteredItems.sort(orderByTemp);
        default:
          return this.filteredItems;
      }
    }
  },
  // mounted() {
  //   this.$root.$on("remove", function(id) {
  //     console.log(sharedData);
  //   });
  // },
  methods: {
    getCelseTemp(data) {
      return Math.round(data - 273);
    },
    addNewCity(e) {
      if (this.inputValueOfCity !== "") {
        this.input_type = "is-primary";
        fetch(
          `https://api.openweathermap.org/data/2.5/weather?q=${this.inputValueOfCity}&lang=ru&appid=a7b7478ece778d4363053ebdbadd7249`
        )
          .then(response => {
            if (response.status >= 200 && response.status < 300) {
              return response;
            } else {
              let error = new Error(response.statusText);
              error.response = response;
              throw error;
            }
          })
          .then(response => response.json())
          .then(json => this.data.push(json))
          .catch(error => {
            this.input_type = "is-danger";
            // this.errorPull = error.message;
          });
      } else {
        this.input_type = "is-danger";
      }
    },
    removeCity(item) {
      var idx = this.data.indexOf(item);
      this.data.splice(idx, 1);
    }
  },
  mounted() {
    console.log(this.data);
    const asyncAxiosApi = async () => {
      await this.city.forEach((item, i) => {
        // let url = `https://api.openweathermap.org/data/2.5/weather?id=${item}&lang=ru&appid=a7b7478ece778d4363053ebdbadd7249`;

        // // create a new instance so we don't delete the headers for other requests
        // let instance = this.$axios.create();

        // // delete headers if existing
        // delete instance.defaults.headers.common["Accept"];
        // delete instance.defaults.headers.common["X-Requested-With"];
        // delete instance.defaults.headers.common["X-CSRF-TOKEN"];

        // this.$axios
        // instance
        // .get
        //         {
        // crossdomain: true,
        // headers: {
        //   Accept: "application/json",
        //   "Content-Type": "application/x-www-form-urlencoded"
        //   // "Access-Control-Allow-Origin": "*"
        // }}

        // .then(response => this.data.push(response.data))
        // .catch(error => {
        //   if (this.$axios.isCancel(error)) {
        //     console.log("Request canceled " + error);
        //     this.errorPull = "Request canceled " + error;
        //   } else {
        //     this.errorPull = error.message;
        //     console.log(this.errorPull);
        //   }
        // });

        //CORS AXIOS DIDNT WORK!!! REWORK on fetch

        fetch(
          `https://api.openweathermap.org/data/2.5/weather?id=${item}&lang=ru&appid=a7b7478ece778d4363053ebdbadd7249`
        )
          .then(response => {
            if (response.status >= 200 && response.status < 300) {
              return response;
            } else {
              let error = new Error(response.statusText);
              error.response = response;
              throw error;
            }
          })
          .then(response => response.json())
          .then(json => this.data.push(json))
          .catch(error => {
            this.errorPull = error.message;
            console.log("Error: " + error.message);
            console.log(error.response);
          });
      });
    };
    if (this.$nuxt.data != null) {
    } else asyncAxiosApi();
  }
};
var orderByName = function(d1, d2) {
  return d1.name.toLowerCase() > d2.name.toLowerCase() ? 1 : -1;
};
var orderByTemp = function(d1, d2) {
  return d1.main.temp < d2.main.temp ? 1 : -1;
};
</script>
<style lang="scss" scoped>
.flex {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  .field:not(:last-child) {
    margin-bottom: 0;
  }
  .field {
    width: calc(100% - 120px);
  }
  .button {
    // margin: 0 auto;
  }
}

.field.has-addons {
  .control {
    width: 100%;
  }
}
.progress-wrapper {
  margin-top: 15px;
}
.b-checkbox {
  outline: none;
  -webkit-tap-highlight-color: transparent;
}
.b-checkbox.checkbox input[type="checkbox"]:focus:checked + .check {
  box-shadow: none;
}
p.help {
  position: absolute;
}
.weather-info {
  li {
    display: flex;
    align-items: center;
    // justify-content: ;
    margin: 15px 0;
    a {
      display: flex;
      align-items: center;
      // justify-content: ;
      margin: 15px 0;
    }
    img.del {
      width: 15px;
      margin-left: auto;
      justify-self: flex-end;
      // stroke: red;
      opacity: 0.5;
      cursor: pointer;
    }
    .wrapper {
      // border: solid $primary 2px;
      background: $primary;
      min-width: 50px;
      width: 50px;
      height: 50px;
      display: block;
      position: relative;
      margin-right: 15px;
      border-radius: 50%;
      img {
        // mix-blend-mode: screen;
        mix-blend-mode: color-dodge;
        // mix-blend-mode: luminosity;
      }
    }
  }
}
</style>
